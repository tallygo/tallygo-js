<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TallyGo Current location animation</title>
    <meta name="description" content="TallyGo Current Location animation">
    <meta name="author" content="TallyGo">
    <script src="node_modules/mapbox-gl/dist/mapbox-gl-dev.js"></script>
    <link rel="stylesheet" media="screen" href="node_modules/mapbox-gl/dist/mapbox-gl.css" />
    <script src="dist/browser.js"></script>
  </head>
  <body>
    <div id="tallygo-map"></div>
    <script>
      const tallygo = TallyGo.configure({
        apiToken: '22a2db381ba59ca2b4be2d21cea456e7',
        map: { navPosition: 'top-left' },
        // TODO: Remove the need to set the request apiUrl if it isn't used
        request: { apiUrl: 'https://api.tallygo.com/v1/route' }
      })

      let map = tallygo.map.glMap

      function initPoint(map) {
        let _point = {
          "type": "FeatureCollection",
          "features": [{
            "type": "Feature",
            "properties": {},
            "geometry": {
              "type": "Point",
              "coordinates": [0, 0] // Place off screen initially
            }
          }]
        }

        map.addSource('point', {
          "type": "geojson",
          "data": _point
        })
        map.addLayer({
          "id": "point",
          "source": "point",
          "type": "symbol",
          "layout": {
            "icon-image": "car-taxi",
            "icon-rotate": ["get", "bearing"],
            "icon-rotation-alignment": "map",
            "icon-allow-overlap": true,
            "icon-ignore-placement": true
          }
        })
        return _point
      }

      function flyToOptions(zoom, coordinates) {
        if (zoom <= 5) {
          return {
            center: coordinates,
            zoom: 15,
            speed: 1
          }
        }
        return {
          center: coordinates,
          zoom: zoom,
          speed: 0.2
        }
      }

      map.on('load', function () {
        map.loadImage('images/car-taxi.png', function(error, image) {
          if (error) throw error;
          map.addImage('car-taxi', image);
        })

        const ws = new TallyGo.WebSocket('ws://localhost:3200')
        let animationBuffer = new TallyGo.AnimationBuffer(700)
        let point = initPoint(map)

        function animate() {
          point.features[0].geometry.coordinates = animationBuffer.current()
          point.features[0].properties.bearing = TallyGo.turf.bearing(
            TallyGo.turf.point(animationBuffer.current()),
            TallyGo.turf.point(animationBuffer.next())
          );

          // Update the map with this new data.
          map.getSource('point').setData(point);

          if (animationBuffer.continue()) {
            // Request the next frame of animation unless we are approaching
            // the end of the buffer.
            requestAnimationFrame(animate)
            animationBuffer.advance()
          } else {
            // Remove all the coordinates that have already been animated.
            animationBuffer.truncate()
          }
        }

        ws.onopen = function() {
          console.log("socket is open");
        }
        ws.onmessage = function (evt) {
          var received_msg = JSON.parse(evt.data)
          var coordinates = [
            received_msg.payload.longitude,
            received_msg.payload.latitude
          ]

          map.flyTo(
            flyToOptions(map.getZoom(), coordinates)
          )

          animationBuffer.add(coordinates)

          if (animationBuffer.length > 2) {
            animate()
          }
        }
        ws.onclose = function() {
          console.log("Connection is closed...")
        }
      })
    </script>
  </body>
</html>
