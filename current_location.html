<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TallyGo Current location animation</title>
    <meta name="description" content="TallyGo Current Location animation">
    <meta name="author" content="TallyGo">
    <script src="node_modules/mapbox-gl/dist/mapbox-gl-dev.js"></script>
    <link rel="stylesheet" media="screen" href="node_modules/mapbox-gl/dist/mapbox-gl.css" />
    <script src="dist/browser.js"></script>
  </head>
  <body>
    <div id="tallygo-map"></div>
    <script>
      function extractUpdate(received_msg) {
        return {
          session_id: received_msg.session_id,
          coordinates: [
            received_msg.payload.longitude,
            received_msg.payload.latitude
          ]
        }
      }
      function flyToOptions(zoom, coordinates) {
        if (zoom <= 5) {
          return {
            center: coordinates,
            zoom: 15,
            speed: 1
          }
        }
        return {
          center: coordinates,
          zoom: zoom,
          speed: 0.2
        }
      }

      const tallygo = TallyGo.configure({
        apiToken: '22a2db381ba59ca2b4be2d21cea456e7',
        map: { navPosition: 'top-left' },
        // TODO: Remove the need to set the request apiUrl if it isn't used
        request: { apiUrl: 'https://api.tallygo.com/v1/route' }
      })
      const webSocket = new TallyGo.WebSocket('ws://localhost:3200')
      const vehicleIcon = 'car-taxi'
      const vehicles = new TallyGo.VehicleCollection(tallygo.map, vehicleIcon, 600)

      webSocket.onopen = function() { console.log("socket is open") }
      webSocket.onclose = function() { console.log("Connection is closed...") }

      vehicles.map.glMap.loadImage('images/car-taxi.png', function(error, image) {
        if (error) throw error;
        vehicles.map.glMap.addImage(vehicleIcon, image)
      })

      let animationFunction = function() {
        function animate() {
          if (vehicles.continueAnimation()) {
            window.requestAnimationFrame(animate)
          }
        }

        webSocket.onmessage = function(event) {
          let update = extractUpdate(JSON.parse(event.data))

          if (vehicles.length() < 2) {
            vehicles.map.glMap.flyTo(
              flyToOptions(vehicles.map.glMap.getZoom(), update.coordinates)
            )
          }

          if (vehicles.locationUpdate(update)) {
            animate()
          }
        }
      }
      vehicles.map.glMap.on('load', animationFunction)
    </script>
  </body>
</html>
