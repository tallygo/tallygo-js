<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TallyGo Current location animation</title>
    <meta name="description" content="TallyGo Current Location animation">
    <meta name="author" content="TallyGo">
    <script src="node_modules/mapbox-gl/dist/mapbox-gl-dev.js"></script>
    <link rel="stylesheet" media="screen" href="node_modules/mapbox-gl/dist/mapbox-gl.css" />
    <script src="dist/browser.js"></script>
  </head>
  <body>
    <div id="tallygo-map"></div>
    <script>
      const tallygo = TallyGo.configure({
        apiToken: '22a2db381ba59ca2b4be2d21cea456e7',
        map: { navPosition: 'top-left' },
        // TODO: Remove the need to set the request apiUrl if it isn't used
        request: { apiUrl: 'https://api.tallygo.com/v1/route' }
      })

      let map = tallygo.map.glMap

      function flyToOptions(zoom, coordinates) {
        if (zoom <= 5) {
          return {
            center: coordinates,
            zoom: 15,
            speed: 1
          }
        }
        return {
          center: coordinates,
          zoom: zoom,
          speed: 0.2
        }
      }

      const webSocket = new TallyGo.WebSocket('ws://localhost:3200')
      const vehicleIcon = 'car-taxi'

      map.loadImage('images/car-taxi.png', function(error, image) {
        if (error) throw error;
        map.addImage(vehicleIcon, image);
      })

      const animationBuffer = new TallyGo.AnimationBuffer(600)
      const vehicleLayer = TallyGo.vehiclePointLayer({iconImage: vehicleIcon})

      map.on('load', function () {
        tallygo.map.addLayer(vehicleLayer)

        function animate() {
          vehicleLayer.source.data.features[0].geometry.coordinates = animationBuffer.current().coordinates
          vehicleLayer.source.data.features[0].properties.bearing = animationBuffer.current().bearing
          map.getSource(vehicleLayer.id).setData(vehicleLayer.source.data)

          if (animationBuffer.continue()) { requestAnimationFrame(animate) }
        }

        webSocket.onopen = function() {
          console.log("socket is open");
        }
        webSocket.onmessage = function (evt) {
          var received_msg = JSON.parse(evt.data)
          var coordinates = [
            received_msg.payload.longitude,
            received_msg.payload.latitude
          ]

          map.flyTo(
            flyToOptions(map.getZoom(), coordinates)
          )

          animationBuffer.add(coordinates)
          console.log("points: ", animationBuffer.length)

          if (animationBuffer.length > 1 && animationBuffer.currentIndex === 0) {
            animate()
          }
        }
        webSocket.onclose = function() {
          console.log("Connection is closed...")
        }
      })
    </script>
  </body>
</html>
