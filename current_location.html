<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>TallyGo Current location animation</title>
    <meta name="description" content="TallyGo Current Location animation">
    <meta name="author" content="TallyGo">
    <script src="node_modules/mapbox-gl/dist/mapbox-gl-dev.js"></script>
    <link rel="stylesheet" media="screen" href="node_modules/mapbox-gl/dist/mapbox-gl.css" />
    <script src="dist/browser.js"></script>
  </head>
  <body>
    <div id="tallygo-map"></div>
    <script>
      const tallygo = TallyGo.configure({
        apiToken: '22a2db381ba59ca2b4be2d21cea456e7',
        map: { navPosition: 'top-left' },
        // TODO: Remove the need to set the request apiUrl if it isn't used
        request: { apiUrl: 'https://api.tallygo.com/v1/route' }
      })

      let map = tallygo.map.glMap

      function flyToOptions(zoom, coordinates) {
        if (zoom <= 5) {
          return {
            center: coordinates,
            zoom: 15,
            speed: 1
          }
        }
        return {
          center: coordinates,
          zoom: zoom,
          speed: 0.2
        }
      }

      const webSocket = new TallyGo.WebSocket('ws://localhost:3200')
      const animationBuffer = new TallyGo.AnimationBuffer(10)
      const vehicleIcon = 'car-taxi'
      const vehicleLayer = TallyGo.vehiclePointLayer({iconImage: vehicleIcon})
      const sourceData = vehicleLayer.source.data
      let currentBearing = 0

      map.loadImage('images/car-taxi.png', function(error, image) {
        if (error) throw error;
        map.addImage(vehicleIcon, image);
      })

      function not_between(previous, current, range) {
        if (current > previous + range || current < previous - range) {
          return false
        }
        return false
      }
      map.on('load', function () {
        tallygo.map.addLayer(vehicleLayer)

        function animate() {
          if (not_between(currentBearing, animationBuffer.currentBearing(), 5)) {
            console.log('=================')
            console.log('Previous bearing was: ', currentBearing)
            console.log('Current bearing is: ', animationBuffer.currentBearing())
            console.log('previous: ', animationBuffer[animationBuffer.currentIndex - 1])
            console.log('current (bearingStart): ', animationBuffer.bearingStart())
            console.log('next (bearingEnd): ', animationBuffer.bearingEnd())
            console.log('after next: ', animationBuffer[animationBuffer.currentIndex + 2])
            console.log('currentIndex: ', animationBuffer.currentIndex)
            console.log('=================')
          }
          currentBearing = animationBuffer.currentBearing()
          sourceData.features[0].geometry.coordinates = animationBuffer.current()
          sourceData.features[0].properties.bearing = animationBuffer.currentBearing()

          map.getSource(vehicleLayer.id).setData(sourceData);

          console.log('Current bearing was: ', currentBearing)
          console.log("animationBuffer.length: ", animationBuffer.length)
          console.log("animationBuffer.currentIndex: ", animationBuffer.currentIndex)
          console.log('=================')
          if (animationBuffer.continue()) {
            // Request the next frame of animation unless we are approaching
            // the end of the buffer.
            animationBuffer.advance()
            requestAnimationFrame(animate)
          } else {
            // Remove all the coordinates that have already been animated.
            animationBuffer.truncate(0)
          }
          console.log("animationBuffer.currentIndex after continue(): ", animationBuffer.currentIndex)
          console.log('=================')
        }

        webSocket.onopen = function() {
          console.log("socket is open");
        }
        webSocket.onmessage = function (evt) {
          var received_msg = JSON.parse(evt.data)
          console.log(received_msg)
          var coordinates = [
            received_msg.payload.longitude,
            received_msg.payload.latitude
          ]


          map.flyTo(
            flyToOptions(map.getZoom(), coordinates)
          )

          animationBuffer.add(coordinates)
          if (animationBuffer.length > 1 && animationBuffer.currentIndex === 0) {
            animate()
          }
          if (animationBuffer.length === 53) {
            console.log(animationBuffer)
          }
        }
        webSocket.onclose = function() {
          console.log("Connection is closed...")
        }
      })
    </script>
  </body>
</html>
